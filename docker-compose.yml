services:
  frontend:
    build: ./frontend
    ports:
      - "${FRONTEND_PORT}:80" # Käytetään .env-tiedostosta määritettyä porttia
    volumes:
      - ./frontend:/usr/share/nginx/html
      # Frontend odottaa nyt, että backend on oikeasti "healthy" ennen käynnistymistä
    depends_on:
      notes-api:
        condition: service_healthy

  notes-api:
    build: ./notes-api
    # Backendille ei tarvita ports-määritystä ulospäin, koska Nginx hoitaa liikenteen.
    volumes:
      - ./notes-api:/app
      - ./notes-data:/data
    # HEALTHCHECK: Docker pingaa backendia 30s välein varmistaakseen että se toimii
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/notes"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s